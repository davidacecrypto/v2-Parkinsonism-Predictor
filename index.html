<!DOCTYPE html>
<html>
<head>
    <title>üß† V2 - Advanced Parkinsonism Predictor</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            padding: 30px; 
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }
        .container { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .control-panel, .results { 
            background: white; 
            padding: 25px; 
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .slider-container { 
            margin: 15px 0; 
        }
        .slider { 
            width: 100%; 
            margin: 8px 0;
        }
        .result-box { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
        }
        .control { background: #e8f5e8; color: #2e7d32; }
        .early { background: #fff3e0; color: #ef6c00; }
        .advanced { background: #ffebee; color: #c62828; }
        .file-upload {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px dashed #2196F3;
        }
        .gene-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß† V2 - Advanced Parkinsonism Predictor</h1>
        <p>Analysis of 8 Autophagy Genes from NCBI GSE Files</p>
    </div>

    <div class="container">
        <div class="control-panel">
            <h2>üî¨ Analysis Methods</h2>
            
            <div class="file-upload">
                <h3>üìÅ Upload NCBI GSE File</h3>
                <input type="file" id="fileInput" accept=".txt,.csv,.tsv">
                <button onclick="processFile()">Analyze GSE File</button>
                <p style="font-size: 12px; color: #666;">Upload Series Matrix files from NCBI GEO</p>
            </div>

            <h3>üéöÔ∏è Manual Gene Input</h3>
            <div class="gene-grid">
                <div class="slider-container">
                    <label>Atg1/Ulk1 (FBgn0261572): <span id="atg1-value">0.5</span></label>
                    <input type="range" min="0" max="10" step="0.1" value="0.5" class="slider" id="atg1">
                </div>
                
                <div class="slider-container">
                    <label>Atg5 (FBgn0053513): <span id="atg5-value">0.05</span></label>
                    <input type="range" min="0" max="1" step="0.001" value="0.05" class="slider" id="atg5">
                </div>
                
                <div class="slider-container">
                    <label>Atg7 (FBgn0026370): <span id="atg7-value">4.5</span></label>
                    <input type="range" min="0" max="10" step="0.1" value="4.5" class="slider" id="atg7">
                </div>
                
                <div class="slider-container">
                    <label>Atg8a (FBgn0026562): <span id="atg8a-value">1.5</span></label>
                    <input type="range" min="0" max="10" step="0.1" value="1.5" class="slider" id="atg8a">
                </div>
                
                <div class="slider-container">
                    <label>Lamp1 (FBgn0010337): <span id="lamp1-value">2.0</span></label>
                    <input type="range" min="0" max="10" step="0.1" value="2.0" class="slider" id="lamp1">
                </div>
                
                <div class="slider-container">
                    <label>Ref(2)P (FBgn0025772): <span id="ref2p-value">1.0</span></label>
                    <input type="range" min="0" max="10" step="0.1" value="1.0" class="slider" id="ref2p">
                </div>
                
                <div class="slider-container">
                    <label>Pink1 (FBgn0039047): <span id="pink1-value">0.8</span></label>
                    <input type="range" min="0" max="10" step="0.1" value="0.8" class="slider" id="pink1">
                </div>
                
                <div class="slider-container">
                    <label>Parkin (FBgn0024324): <span id="parkin-value">0.6</span></label>
                    <input type="range" min="0" max="10" step="0.1" value="0.6" class="slider" id="parkin">
                </div>
            </div>
        </div>

        <div class="results">
            <h2>üìä Prediction Results</h2>
            <div id="stage-result" class="result-box control">
                Predicted Stage: 0.0
            </div>
            <div id="status-result" class="result-box control">
                Status: üü¢ CONTROL
            </div>
            <div id="confidence-result" class="result-box">
                Confidence: 85.0%
            </div>

            <div id="gene-results">
                <h3>üß¨ Detected Genes</h3>
                <div id="gene-list">No genes analyzed yet</div>
            </div>

            <div id="interpretation">
                <h3>üìã Clinical Interpretation</h3>
                <p id="interpretation-text">CONTROL PATTERN - Normal autophagy activity detected</p>
            </div>
        </div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h2>üìà Target Gene Database</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Gene</th><th>Flybase ID</th><th>Function</th><th>Control Range</th><th>Parkinsonism Range</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>Atg1/Ulk1</td><td>FBgn0261572</td><td>Autophagy initiation</td><td>0.3-0.8</td><td>0.1-0.4</td></tr>
                <tr><td>Atg5</td><td>FBgn0053513</td><td>Autophagosome formation</td><td>0.08-0.15</td><td>0.01-0.05</td></tr>
                <tr><td>Atg7</td><td>FBgn0026370</td><td>E1-like enzyme</td><td>4.2-4.8</td><td>4.3-4.7</td></tr>
                <tr><td>Atg8a</td><td>FBgn0026562</td><td>LC3 homolog</td><td>0.1-1.0</td><td>1.5-4.0</td></tr>
                <tr><td>Lamp1</td><td>FBgn0010337</td><td>Lysosomal marker</td><td>1.5-2.5</td><td>2.5-4.0</td></tr>
                <tr><td>Ref(2)P</td><td>FBgn0025772</td><td>p62/SQSTM1 homolog</td><td>0.5-1.5</td><td>2.0-5.0</td></tr>
                <tr><td>Pink1</td><td>FBgn0039047</td><td>Mitochondrial quality control</td><td>0.5-1.2</td><td>0.2-0.8</td></tr>
                <tr><td>Parkin</td><td>FBgn0024324</td><td>E3 ubiquitin ligase</td><td>0.4-1.0</td><td>0.1-0.5</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        // Gene database with Flybase IDs
        const geneDatabase = {
            'FBgn0261572': 'Atg1/Ulk1',
            'FBgn0053513': 'Atg5', 
            'FBgn0026370': 'Atg7',
            'FBgn0026562': 'Atg8a',
            'FBgn0010337': 'Lamp1',
            'FBgn0025772': 'Ref(2)P',
            'FBgn0039047': 'Pink1',
            'FBgn0024324': 'Parkin'
        };

        function processFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a GSE file first!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                analyzeGSEFile(content);
            };
            reader.readAsText(file);
        }

        function analyzeGSEFile(content) {
            const lines = content.split('\n');
            let foundGenes = [];
            let geneValues = {};

            // Initialize all genes
            Object.keys(geneDatabase).forEach(fbId => {
                geneValues[geneDatabase[fbId]] = null;
            });

            // Search for Flybase IDs in the file
            lines.forEach(line => {
                // Skip metadata lines (start with !)
                if (line.startsWith('!')) return;
                
                // Split by tabs or spaces
                const parts = line.trim().split(/\s+/);
                if (parts.length < 3) return;

                const flybaseId = parts[0];
                
                // Check if this is one of our target genes
                if (geneDatabase[flybaseId]) {
                    const geneName = geneDatabase[flybaseId];
                    foundGenes.push(geneName);
                    
                    // Try to parse expression values (skip locus info)
                    for (let i = 2; i < Math.min(parts.length, 8); i++) {
                        const value = parseFloat(parts[i]);
                        if (!isNaN(value)) {
                            if (!geneValues[geneName]) {
                                geneValues[geneName] = [];
                            }
                            geneValues[geneName].push(value);
                        }
                    }
                }
            });

            // Update UI with found genes
            updateGeneResults(foundGenes, geneValues);
            
            // Auto-update sliders with average values
            updateSlidersWithData(geneValues);
            
            // Run prediction
            updatePrediction();
        }

        function updateGeneResults(foundGenes, geneValues) {
            const geneList = document.getElementById('gene-list');
            
            if (foundGenes.length === 0) {
                geneList.innerHTML = '<p style="color: red;">No target genes found in file</p>';
                return;
            }

            let html = '<table class="data-table"><tr><th>Gene</th><th>Avg Expression</th><th>Range</th></tr>';
            
            foundGenes.forEach(gene => {
                const values = geneValues[gene];
                if (values && values.length > 0) {
                    const avg = (values.reduce((a, b) => a + b, 0) / values.length).toFixed(3);
                    const min = Math.min(...values).toFixed(3);
                    const max = Math.max(...values).toFixed(3);
                    html += `<tr><td>${gene}</td><td>${avg}</td><td>${min}-${max}</td></tr>`;
                }
            });
            
            html += '</table>';
            geneList.innerHTML = html;
        }

        function updateSlidersWithData(geneValues) {
            Object.keys(geneValues).forEach(gene => {
                const values = geneValues[gene];
                if (values && values.length > 0) {
                    const avg = values.reduce((a, b) => a + b, 0) / values.length;
                    const slider = document.getElementById(gene.toLowerCase().replace('/', '').replace('(', '').replace(')', ''));
                    if (slider) {
                        slider.value = avg;
                        // Trigger the update event
                        slider.dispatchEvent(new Event('input'));
                    }
                }
            });
        }

        function updatePrediction() {
            // Get all gene values
            const genes = {
                'Atg1/Ulk1': parseFloat(document.getElementById('atg1').value),
                'Atg5': parseFloat(document.getElementById('atg5').value),
                'Atg7': parseFloat(document.getElementById('atg7').value),
                'Atg8a': parseFloat(document.getElementById('atg8a').value),
                'Lamp1': parseFloat(document.getElementById('lamp1').value),
                'Ref(2)P': parseFloat(document.getElementById('ref2p').value),
                'Pink1': parseFloat(document.getElementById('pink1').value),
                'Parkin': parseFloat(document.getElementById('parkin').value)
            };

            // Update displayed values
            Object.keys(genes).forEach(gene => {
                const element = document.getElementById(gene.toLowerCase().replace('/', '').replace('(', '').replace(')', '') + '-value');
                if (element) {
                    element.textContent = genes[gene].toFixed(3);
                }
            });

            // Advanced prediction algorithm using all 8 genes
            let score = 0;
            let factors = [];

            // Atg8a and Ref(2)P - strong indicators
            if (genes['Atg8a'] > 2.0) {
                score += (genes['Atg8a'] - 2.0) * 2;
                factors.push(`High Atg8a (${genes['Atg8a'].toFixed(2)})`);
            }
            if (genes['Ref(2)P'] > 2.0) {
                score += (genes['Ref(2)P'] - 2.0) * 1.5;
                factors.push(`High Ref(2)P (${genes['Ref(2)P'].toFixed(2)})`);
            }

            // Atg5 and Parkin - reduction indicates impairment
            if (genes['Atg5'] < 0.05) {
                score += (0.05 - genes['Atg5']) * 20;
                factors.push(`Low Atg5 (${genes['Atg5'].toFixed(3)})`);
            }
            if (genes['Parkin'] < 0.3) {
                score += (0.3 - genes['Parkin']) * 3;
                factors.push(`Low Parkin (${genes['Parkin'].toFixed(2)})`);
            }

            // Lamp1 - lysosomal stress marker
            if (genes['Lamp1'] > 3.0) {
                score += (genes['Lamp1'] - 3.0) * 1;
                factors.push(`Elevated Lamp1 (${genes['Lamp1'].toFixed(2)})`);
            }

            // Determine stage based on composite score
            let stage, status, interpretation, className;
            
            if (score > 4.0) {
                stage = 2.0;
                status = "üî¥ ADVANCED PARKINSONISM";
                interpretation = `ADVANCED PATTERN - Severe autophagy-mitochondrial dysfunction. Key factors: ${factors.join(', ')}.`;
                className = "advanced";
            } else if (score > 1.5) {
                stage = 1.0;
                status = "üü° EARLY STAGE";
                interpretation = `EARLY PATTERN - Moderate dysregulation. Key factors: ${factors.join(', ')}.`;
                className = "early";
            } else {
                stage = 0.0;
                status = "üü¢ CONTROL";
                interpretation = "CONTROL PATTERN - Normal autophagy-mitochondrial function detected.";
                className = "control";
            }

            // Update results
            document.getElementById('stage-result').textContent = `Predicted Stage: ${stage.toFixed(1)}`;
            document.getElementById('status-result').textContent = `Status: ${status}`;
            document.getElementById('interpretation-text').textContent = interpretation;
            
            // Update styling
            document.getElementById('stage-result').className = `result-box ${className}`;
            document.getElementById('status-result').className = `result-box ${className}`;
        }

        // Initialize event listeners
        document.querySelectorAll('.slider').forEach(slider => {
            slider.addEventListener('input', updatePrediction);
        });
        
        updatePrediction(); // Initial calculation
    </script>
</body>
</html>
